---
layout: post
title: C#背景操作Excel不會殘留執行緒的方式
tag:
- c#
- excel
---

<p><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #267f99; font-size: 14px; white-space: pre;">Microsoft</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">.</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #267f99; font-size: 14px; white-space: pre;">Office</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">.</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #267f99; font-size: 14px; white-space: pre;">Interop</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">.</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #267f99; font-size: 14px; white-space: pre;">Excel</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">.</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #267f99; font-size: 14px; white-space: pre;">Application</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">&nbsp;</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #001080; font-size: 14px; white-space: pre;">application</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">&nbsp;=&nbsp;</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: blue; font-size: 14px; white-space: pre;">null</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">;
</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #267f99; font-size: 14px; white-space: pre;">Microsoft</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">.</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #267f99; font-size: 14px; white-space: pre;">Office</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">.</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #267f99; font-size: 14px; white-space: pre;">Interop</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">.</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #267f99; font-size: 14px; white-space: pre;">Excel</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">.</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #267f99; font-size: 14px; white-space: pre;">Workbooks</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">&nbsp;</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #001080; font-size: 14px; white-space: pre;">workbooks</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">&nbsp;=&nbsp;</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: blue; font-size: 14px; white-space: pre;">null</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">;
</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #267f99; font-size: 14px; white-space: pre;">Microsoft</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">.</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #267f99; font-size: 14px; white-space: pre;">Office</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">.</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #267f99; font-size: 14px; white-space: pre;">Interop</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">.</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #267f99; font-size: 14px; white-space: pre;">Excel</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">.</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #267f99; font-size: 14px; white-space: pre;">Workbook</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">&nbsp;</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: #001080; font-size: 14px; white-space: pre;">workbook</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">&nbsp;=&nbsp;</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; color: blue; font-size: 14px; white-space: pre;">null</span><span face="Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace" style="background-color: white; font-size: 14px; white-space: pre;">;</span></p><div style="background-color: white; font-family: Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;"><div><span style="color: #af00db;">try</span>&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">application</span>&nbsp;=&nbsp;<span style="color: blue;">new</span>&nbsp;<span style="color: #267f99;">Microsoft</span>.<span style="color: #267f99;">Office</span>.<span style="color: #267f99;">Interop</span>.<span style="color: #267f99;">Excel</span>.<span style="color: #267f99;">Application</span>();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">workbooks</span>&nbsp;=&nbsp;<span style="color: #001080;">application</span>.<span style="color: #001080;">Workbooks</span>;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">workbook</span>&nbsp;=&nbsp;<span style="color: #001080;">workbooks</span>.<span style="color: #795e26;">Open</span>(<span style="color: #a31515;">@"Excel檔案路徑"</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>);</div><br /><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">//workbook相關操作</span></div><div>}</div><div><span style="color: #af00db;">catch</span>&nbsp;(<span style="color: #267f99;">System</span>.<span style="color: #267f99;">Exception</span>&nbsp;<span style="color: #001080;">ex</span>)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">//異常處理動作</span></div><div>}</div><div><span style="color: #af00db;">finally</span>&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;(<span style="color: #001080;">workbook</span>&nbsp;!=&nbsp;<span style="color: blue;">null</span>)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">workbook</span>.<span style="color: #795e26;">Close</span>(<span style="color: blue;">false</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>,&nbsp;<span style="color: #001080;">Type</span>.<span style="color: #001080;">Missing</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Marshal</span>.<span style="color: #795e26;">ReleaseComObject</span>(<span style="color: #001080;">workbook</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;}</div><br /><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;(<span style="color: #001080;">workbooks</span>&nbsp;!=&nbsp;<span style="color: blue;">null</span>)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">workbooks</span>.<span style="color: #795e26;">Close</span>();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Marshal</span>.<span style="color: #795e26;">ReleaseComObject</span>(<span style="color: #001080;">workbooks</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;}</div><br /><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;(<span style="color: #001080;">application</span>&nbsp;!=&nbsp;<span style="color: blue;">null</span>)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">application</span>.<span style="color: #795e26;">Quit</span>();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Marshal</span>.<span style="color: #795e26;">ReleaseComObject</span>(<span style="color: #001080;">application</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>}</div><div><br /></div><div>參考來源：<a href="https://stackoverflow.com/a/158752">https://stackoverflow.com/a/158752</a></div></div>
