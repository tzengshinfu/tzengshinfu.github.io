---
layout: post
title: msdeploy執行script(Server端)
tag:
- dos command
- visual studio
---

<pre><code class="bat"> @ECHO OFF<br /> SET APP=%1<br /> ::此script檔執行需帶參數=%APP%<br /> <br /> <br /> ::置換Web.config DB連線字串<br /> powershell -command "(Get-Content &lt;專案路徑&gt;\Web.config) -replace ('initial catalog=[a-zA-Z0-9]+;', 'initial catalog=%APP%;') | Out-File &lt;專案路徑&gt;\Web.config"<br /> <br /> <br /> ::建置專案<br /> "MSBuild.exe" "&lt;專案名稱&gt;.csproj" /p:DeployOnBuild=true /property:Configuration=Debug<br /> <br /><br /> ::建立資料夾在伺服器的C槽<br /> wmic /node:'&lt;主機名稱&gt;' /user:&lt;網域\管理者名稱&gt; /password:'&lt;管理者密碼&gt;' process call create 'cmd.exe /c mkdir C:\%APP%'<br /> <br /><br /> ::建立應用程序在伺服器IIS<br /> wmic /node:'&lt;主機名稱&gt;' /user:&lt;網域\管理者名稱&gt; /password:'&lt;管理者密碼&gt;' process call create '%systemroot%\system32\inetsrv\appcmd.exe add APPPOOL /name:%APP% /managedRuntimeVersion:"v4.0" /managedPipelineMode:"Integrated" /startMode:AlwaysRunning /recycling.periodicRestart.time:00:00:00 /failure.rapidFailProtection:False /processModel.idleTimeoutAction:Suspend'<br /> wmic /node:'&lt;主機名稱&gt;' /user:&lt;網域\管理者名稱&gt; /password:'&lt;管理者密碼&gt;' process call create '%systemroot%\system32\inetsrv\appcmd.exe add APP /path:/%APP% /physicalPath:C:\%APP% /site.name:"Default Web Site" /applicationPool:%APP% /preloadEnabled:True'<br /> wmic /node:'&lt;主機名稱&gt;' /user:&lt;網域\管理者名稱&gt; /password:'&lt;管理者密碼&gt;' process call create '%systemroot%\system32\inetsrv\appcmd.exe set CONFIG "Default Web Site/%APP%" /section:urlCompression /doStaticCompression:True'<br /> wmic /node:'&lt;主機名稱&gt;' /user:&lt;網域\管理者名稱&gt; /password:'&lt;管理者密碼&gt;' process call create '%systemroot%\system32\inetsrv\appcmd.exe set CONFIG "Default Web Site/%APP%" /section:urlCompression /doDynamicCompression:True'<br /> wmic /node:'&lt;主機名稱&gt;' /user:&lt;網域\管理者名稱&gt; /password:'&lt;管理者密碼&gt;' process call create '%systemroot%\system32\inetsrv\appcmd.exe unlock CONFIG /section:anonymousAuthentication'<br /> wmic /node:'&lt;主機名稱&gt;' /user:&lt;網域\管理者名稱&gt; /password:'&lt;管理者密碼&gt;' process call create '%systemroot%\system32\inetsrv\appcmd.exe set CONFIG "Default Web Site/%APP%" /section:anonymousAuthentication /enabled:True'<br /><br /> <br /> ::設定應用程序的資料夾權限<br /> wmic /node:'&lt;主機名稱&gt;' /user:&lt;網域\管理者名稱&gt; /password:'&lt;管理者密碼&gt;' process call create 'cmd.exe /c icacls C:\%APP% /grant "IIS AppPool\%APP%:F"'<br /> <br /><br /> ::部署專案<br /><br /> "msdeploy.exe" -verb:sync -source:iisApp='&lt;專案路徑&gt;PackageTmp' -dest:iisApp='Default Web Site/%APP%',ComputerName='https://&lt;主機名稱&gt;:8172/msdeploy.axd',UserName='&lt;主機名稱&gt;\Administrator',Password='&lt;管理者密碼&gt;',AuthType='Basic',includeAcls='False' -disableLink:AppPoolExtension -disableLink:ContentExtension -disableLink:CertificateExtension -allowUntrusted<br /> <br /><br /> ::連線字串加密<br /><br /> wmic /node:'&lt;主機名稱&gt;' /user:&lt;網域\管理者名稱&gt; /password:'&lt;管理者密碼&gt;' process call create 'aspnet_regiis.exe -pef connectionStrings C:\%APP%'</code></pre><br /> <br /><br />
