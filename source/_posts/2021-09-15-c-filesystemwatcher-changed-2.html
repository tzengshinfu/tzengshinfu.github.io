---
layout: post
title: C# FileSystemWatcher Changed會偵測2次的解決方式
tag:
- c#
---

<div style="background-color: white; font-family: Consolas, 微軟正黑體, Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px; white-space: pre;"><div><span style="color: blue;">namespace</span>&nbsp;<span style="color: #267f99;">FileSystemWatcherTest</span>&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">class</span>&nbsp;<span style="color: #267f99;">Program</span>&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">private</span>&nbsp;<span style="color: blue;">static</span>&nbsp;<span style="color: #267f99;">ConcurrentDictionary</span>&lt;<span style="color: blue;">string</span>,&nbsp;<span style="color: #267f99;">DateTime</span>&gt;&nbsp;<span style="color: #001080;">dic</span>&nbsp;=&nbsp;<span style="color: blue;">new</span>&nbsp;<span style="color: #267f99;">ConcurrentDictionary</span>&lt;<span style="color: blue;">string</span>,&nbsp;<span style="color: #267f99;">DateTime</span>&gt;();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">static</span>&nbsp;<span style="color: blue;">void</span>&nbsp;<span style="color: #795e26;">Main</span>(<span style="color: blue;">string</span>[]&nbsp;<span style="color: #001080;">args</span>)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">var</span>&nbsp;<span style="color: #001080;">watcher</span>&nbsp;=&nbsp;<span style="color: blue;">new</span>&nbsp;<span style="color: #267f99;">FileSystemWatcher</span>&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">//&nbsp;設定要監看的資料夾</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Path</span>&nbsp;=&nbsp;<span style="color: #a31515;">@"監看路徑"</span>,</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">//&nbsp;設定要監看的變更類型(修改=LastWrite/新增&amp;刪除=FileName/更名=Attributes)</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">NotifyFilter</span>&nbsp;=&nbsp;<span style="color: #001080;">NotifyFilters</span>.<span style="color: #001080;">LastWrite</span>&nbsp;|&nbsp;<span style="color: #001080;">NotifyFilters</span>.<span style="color: #001080;">FileName</span>&nbsp;|&nbsp;<span style="color: #001080;">NotifyFilters</span>.<span style="color: #001080;">Attributes</span>,</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">//&nbsp;設定要監看的檔案類型</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Filter</span>&nbsp;=&nbsp;<span style="color: #a31515;">"*.txt"</span>,</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">//&nbsp;設定是否監看子資料夾</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">IncludeSubdirectories</span>&nbsp;=&nbsp;<span style="color: blue;">true</span>,</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">//&nbsp;設定是否啟動元件，必須要設定為&nbsp;true，否則監看事件是不會被觸發</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">EnableRaisingEvents</span>&nbsp;=&nbsp;<span style="color: blue;">true</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</div><br /><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">//&nbsp;設定監看事件對應的處理邏輯</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">watcher</span>.<span style="color: #001080;">Changed</span>&nbsp;+=&nbsp;<span style="color: blue;">new</span>&nbsp;<span style="color: #267f99;">FileSystemEventHandler</span>(<span style="color: #001080;">OnChanged</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">watcher</span>.<span style="color: #001080;">Created</span>&nbsp;+=&nbsp;<span style="color: blue;">new</span>&nbsp;<span style="color: #267f99;">FileSystemEventHandler</span>(<span style="color: #001080;">OnCreated</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">watcher</span>.<span style="color: #001080;">Deleted</span>&nbsp;+=&nbsp;<span style="color: blue;">new</span>&nbsp;<span style="color: #267f99;">FileSystemEventHandler</span>(<span style="color: #001080;">OnDeleted</span>);</div><br /><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Console</span>.<span style="color: #795e26;">ReadLine</span>();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><br /><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">private</span>&nbsp;<span style="color: blue;">static</span>&nbsp;<span style="color: blue;">void</span>&nbsp;<span style="color: #795e26;">OnDeleted</span>(<span style="color: blue;">object</span>&nbsp;<span style="color: #001080;">sender</span>,&nbsp;<span style="color: #267f99;">FileSystemEventArgs</span>&nbsp;<span style="color: #001080;">e</span>)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">//只會偵測1次</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Console</span>.<span style="color: #795e26;">WriteLine</span>(<span style="color: #a31515;">"檔案變更:&nbsp;"</span>&nbsp;+&nbsp;<span style="color: #001080;">e</span>.<span style="color: #001080;">FullPath</span>&nbsp;+&nbsp;<span style="color: #a31515;">"&nbsp;"</span>&nbsp;+&nbsp;<span style="color: #001080;">e</span>.<span style="color: #001080;">ChangeType</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><br /><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">private</span>&nbsp;<span style="color: blue;">static</span>&nbsp;<span style="color: blue;">void</span>&nbsp;<span style="color: #795e26;">OnCreated</span>(<span style="color: blue;">object</span>&nbsp;<span style="color: #001080;">sender</span>,&nbsp;<span style="color: #267f99;">FileSystemEventArgs</span>&nbsp;<span style="color: #001080;">e</span>)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">//只會偵測1次</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Console</span>.<span style="color: #795e26;">WriteLine</span>(<span style="color: #a31515;">"檔案變更:&nbsp;"</span>&nbsp;+&nbsp;<span style="color: #001080;">e</span>.<span style="color: #001080;">FullPath</span>&nbsp;+&nbsp;<span style="color: #a31515;">"&nbsp;"</span>&nbsp;+&nbsp;<span style="color: #001080;">e</span>.<span style="color: #001080;">ChangeType</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><br /><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">private</span>&nbsp;<span style="color: blue;">static</span>&nbsp;<span style="color: blue;">void</span>&nbsp;<span style="color: #795e26;">OnChanged</span>(<span style="color: blue;">object</span>&nbsp;<span style="color: #001080;">source</span>,&nbsp;<span style="color: #267f99;">FileSystemEventArgs</span>&nbsp;<span style="color: #001080;">e</span>)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">//會偵測2次</span></div><div><span style="color: blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#region&nbsp;</span><span style="color: #a31515;">以最後更新時間判斷是否重複偵測變更(參考來源&nbsp;https://www.cnblogs.com/jzywh/archive/2008/07/23/filesystemwatcher.html)</span></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">var</span>&nbsp;<span style="color: #001080;">currentModifyTime</span>&nbsp;=&nbsp;<span style="color: #001080;">File</span>.<span style="color: #795e26;">GetLastWriteTime</span>(<span style="color: #001080;">e</span>.<span style="color: #001080;">FullPath</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">var</span>&nbsp;<span style="color: #001080;">previousModifyTime</span>&nbsp;=&nbsp;<span style="color: blue;">new</span>&nbsp;<span style="color: #267f99;">Func</span>&lt;<span style="color: #267f99;">DateTime</span>&gt;(()&nbsp;=&gt;&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #267f99;">DateTime</span>&nbsp;<span style="color: #001080;">funcResult</span>&nbsp;=&nbsp;<span style="color: #001080;">DateTime</span>.<span style="color: #001080;">MinValue</span>;</div><br /><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">dic</span>.<span style="color: #795e26;">TryGetValue</span>(<span style="color: #001080;">e</span>.<span style="color: #001080;">FullPath</span>,&nbsp;<span style="color: blue;">out</span>&nbsp;<span style="color: #001080;">funcResult</span>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">return</span>&nbsp;<span style="color: #001080;">funcResult</span>;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})();</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">if</span>&nbsp;(<span style="color: #001080;">currentModifyTime</span>&nbsp;==&nbsp;<span style="color: #001080;">previousModifyTime</span>)&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #af00db;">return</span>;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><br /><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">dic</span>.<span style="color: #795e26;">TryRemove</span>(<span style="color: #001080;">e</span>.<span style="color: #001080;">FullPath</span>,&nbsp;<span style="color: blue;">out</span>&nbsp;<span style="color: #001080;">previousModifyTime</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">dic</span>.<span style="color: #795e26;">TryAdd</span>(<span style="color: #001080;">e</span>.<span style="color: #001080;">FullPath</span>,&nbsp;<span style="color: #001080;">currentModifyTime</span>);</div><div><span style="color: blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endregion</span></div><br /><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #001080;">Console</span>.<span style="color: #795e26;">WriteLine</span>(<span style="color: #a31515;">"檔案變更:&nbsp;"</span>&nbsp;+&nbsp;<span style="color: #001080;">e</span>.<span style="color: #001080;">FullPath</span>&nbsp;+&nbsp;<span style="color: #a31515;">"&nbsp;"</span>&nbsp;+&nbsp;<span style="color: #001080;">e</span>.<span style="color: #001080;">ChangeType</span>);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div>}</div><br /></div>
