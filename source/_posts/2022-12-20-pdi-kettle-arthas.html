---
layout: post
title: PDI Kettle異常使用Arthas偵錯排除
tag:
- arthas
- java
- kettle
---

<p>1.Kettle Spoon的[Run SSH commands]連線異常</p><p></p><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEiCfxfPYoN6z5QzAdBy2J-IIqcR6NHKfZFRxgLlA5jwz6vfWOoxHoTnAs3SrbhMd8gOjiqbUqJR4CxurUMAUSlxkZrjnv4aQ8QS-270FiZQXqKo-41r7OmJdylK2ZFhwbjUurQIIOWdBNkWAAcrklrNASuxX-69PXSKNWgxyZ3qA21xz-jxlusrYCJqhw" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img alt="" data-original-height="890" data-original-width="1223" height="233" src="https://blogger.googleusercontent.com/img/a/AVvXsEiCfxfPYoN6z5QzAdBy2J-IIqcR6NHKfZFRxgLlA5jwz6vfWOoxHoTnAs3SrbhMd8gOjiqbUqJR4CxurUMAUSlxkZrjnv4aQ8QS-270FiZQXqKo-41r7OmJdylK2ZFhwbjUurQIIOWdBNkWAAcrklrNASuxX-69PXSKNWgxyZ3qA21xz-jxlusrYCJqhw" width="320" /></a></div><br /><br /><p></p><p><br /></p><p><br /></p><p><br /></p><p><br /></p><p><br /></p><p><br /></p><p><br /></p><p>2.下載<a href="https://arthas.aliyun.com/doc/" rel="nofollow" target="_blank">Arthas</a>並執行，附加到/&lt;Kettle目錄&gt;/launcher/launcher.jar</p><p>3.在GitHub搜尋<a href="https://github.com/jenkinsci/trilead-ssh2/blob/main/src/com/trilead/ssh2/Connection.java" rel="nofollow" target="_blank">source code</a>，得知進行SSH連線的元件是com.trilead.ssh2，方法是connect</p><p>4.輸入tt -t com.trilead.ssh2.Connection connect監控connect方法</p><p>5.回到Spoon，點擊[Test connection]按鈕重現錯誤，記下INDEX數字(本例為<span style="color: #cc0000;">1000</span>)</p><p>6.輸入tt -i <span style="color: #cc0000;">1000</span> -w 'target.connect'觸發錯誤</p><p>7.查看~/logs/arthas/arthas.log，發現"<span face="SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace" style="background-color: white; color: #212529; font-size: 14px;">Caused by: java.io.IOException: Cannot negotiate, proposals do not match</span>"的異常</p><p>8.查詢此<a href="https://www.dell.com/support/kbdoc/zh-tw/000196454/srm-4-7-%E5%B7%B2%E6%8E%92%E5%AE%9A-%E5%A0%B1%E5%91%8A-%E9%81%A0%E7%AB%AF-%E4%BD%8D%E7%BD%AE-ssh-%E5%82%B3%E8%BC%B8-%E5%A4%B1%E6%95%97-%E5%87%BA%E7%8F%BE-cannot-negotiate-proposals-do-not-match-%E9%8C%AF%E8%AA%A4" rel="nofollow" target="_blank">錯誤</a>為SSH演算法不相容，修改伺服端主機的/etc/ssh/sshd_config，<br /><span style="background-color: white; color: #212529; font-family: &quot;Courier New&quot;, Courier, monospace; font-size: 14px;">MACS區段</span>加入hmac-sha1-96，<span style="background-color: white; color: #444444; font-family: &quot;Courier New&quot;, Courier, monospace; font-size: 16px;">Kexalgorithms</span>區段加入diffie-hellman-group-exchange-sha1<br />※Windows主機為%programdata%\ssh\sshd_config</p><p>新增內容如下</p><p>Match Group administrators</p><p>&nbsp; &nbsp; &nbsp; &nbsp;AuthorizedKeysFile __PROGRAMDATA__/ssh/administrators_authorized_keys</p><p>Match all&lt;--如果有Match Group要加這行關閉Match block</p><p><br /></p><p># Pentaho Kettle [Run SSH commands]</p><p>Kexalgorithms +diffie-hellman-group-exchange-sha1</p><p>MACS +hmac-sha1-96</p><p>HostKeyAlgorithms +ssh-rsa,ssh-dss&lt;--Windows主機再加這行</p><p><br /></p><p>9.重啟SSH服務</p><p>10.Kettle Spoon的[Run SSH commands]連線即正常</p><p><br /></p><p>PS:Arthas誠為神器也</p><p>PS:sshd<a href="https://github.com/PowerShell/Win32-OpenSSH/wiki/Logging-Facilities" rel="nofollow" target="_blank">啟用log紀錄</a>會很有幫助</p>
